{% extends "base.html" %}

{% block title %}Market Analysis{% endblock %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.35.3.min.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h1 class="text-2xl font-bold text-gray-900">Market Analysis</h1>
        <p class="text-gray-600 mt-2">Analyze market data and trends</p>
    </div>

    <!-- Market Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Total Symbols Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="text-center">
                <div class="text-3xl font-bold text-gray-900" id="totalSymbols">-</div>
                <div class="text-sm font-medium text-gray-500 mt-2">Total Symbols</div>
            </div>
        </div>

        <!-- Total Records Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="text-center">
                <div class="text-3xl font-bold text-gray-900" id="totalRecords">-</div>
                <div class="text-sm font-medium text-gray-500 mt-2">Total Records</div>
            </div>
        </div>

        <!-- Last Update Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="text-center">
                <div class="text-3xl font-bold text-gray-900" id="lastUpdate">-</div>
                <div class="text-sm font-medium text-gray-500 mt-2">Last Update</div>
            </div>
        </div>
    </div>

    <!-- Chart Controls -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Chart Controls</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Symbol</label>
                <select id="symbolSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">Select a symbol...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
                <select id="periodSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="180">180 days</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Chart Type</label>
                <select id="chartTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="line">Line Chart</option>
                    <option value="candlestick">Candlestick</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Price Chart -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 id="priceChartTitle" class="text-lg font-semibold text-gray-900 mb-4">Price Chart</h2>
        <div id="priceChart" class="h-96 bg-gray-50 rounded-lg flex items-center justify-center">
            <p class="text-gray-500">Please select a symbol to view chart data</p>
        </div>
    </div>

    <!-- Volume Chart -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 id="volumeChartTitle" class="text-lg font-semibold text-gray-900 mb-4">Volume Chart</h2>
        <div id="volumeChart" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
            <p class="text-gray-500">Please select a symbol to view volume data</p>
        </div>
    </div>
</div>

<script>
// Ultra-minimal JavaScript with NO animations, NO timeouts, NO complex logic
document.addEventListener('DOMContentLoaded', function() {
    loadSymbols();
    loadMarketStats();
    
    document.getElementById('symbolSelect').addEventListener('change', function(e) {
        if (e.target.value) {
            loadChartData(e.target.value);
        }
    });
    
    document.getElementById('periodSelect').addEventListener('change', function(e) {
        const symbol = document.getElementById('symbolSelect').value;
        if (symbol) {
            loadChartData(symbol);
        }
    });
    
    document.getElementById('chartTypeSelect').addEventListener('change', function(e) {
        const symbol = document.getElementById('symbolSelect').value;
        if (symbol) {
            loadChartData(symbol);
        }
    });
});

async function loadSymbols() {
    try {
        const response = await fetch('/api/market-data/symbols');
        const symbols = await response.json();
        
        const symbolSelect = document.getElementById('symbolSelect');
        symbols.forEach(symbol => {
            const option = document.createElement('option');
            option.value = symbol.symbol;
            option.textContent = `${symbol.symbol} (${symbol.record_count} records)`;
            symbolSelect.appendChild(option);
        });
    } catch (error) {
        document.getElementById('symbolSelect').innerHTML = '<option value="">Error loading symbols</option>';
    }
}

async function loadMarketStats() {
    try {
        const response = await fetch('/api/market-data/stats');
        const stats = await response.json();
        
        console.log('Market stats:', stats); // Debug log
        
        document.getElementById('totalSymbols').textContent = stats.symbols_count || '-';
        document.getElementById('totalRecords').textContent = stats.total_records ? stats.total_records.toLocaleString() : '-';
        document.getElementById('lastUpdate').textContent = stats.latest_update ? new Date(stats.latest_update).toLocaleString() : '-';
    } catch (error) {
        console.error('Failed to load market stats:', error);
        document.getElementById('totalSymbols').textContent = 'Error';
        document.getElementById('totalRecords').textContent = 'Error';
        document.getElementById('lastUpdate').textContent = 'Error';
    }
}

async function loadChartData(symbol) {
    const period = document.getElementById('periodSelect').value;
    const chartType = document.getElementById('chartTypeSelect').value;
    
    try {
        const response = await fetch(`/api/market-data/data/${symbol}?limit=${period}`);
        const data = await response.json();
        
        // Completely clear containers
        document.getElementById('priceChart').innerHTML = '';
        document.getElementById('volumeChart').innerHTML = '';
        
        // Update card titles
        document.getElementById('priceChartTitle').textContent = `Price Chart for ${symbol}`;
        document.getElementById('volumeChartTitle').textContent = `Volume Chart for ${symbol}`;
        
        // Render charts
        if (chartType === 'candlestick') {
            Plotly.newPlot('priceChart', [{
                x: data.map(d => new Date(d.timestamp)),
                open: data.map(d => d.open),
                high: data.map(d => d.high),
                low: data.map(d => d.low),
                close: data.map(d => d.close),
                type: 'candlestick'
            }], {
                title: '',
                xaxis: { 
                    title: '',
                    rangeslider: { visible: false },
                    showgrid: false,
                    showline: true,
                    linecolor: 'black',
                    linewidth: 1,
                    rangebreaks: [
                        { pattern: 'day of week', bounds: [6, 1] },
                        { pattern: 'hour', bounds: [22, 7] }  // UTC-5: 22:00-07:00 (non-trading hours)
                    ]
                },
                yaxis: { 
                    title: '',
                    showgrid: false
                }
            });
        } else {
            Plotly.newPlot('priceChart', [{
                x: data.map(d => new Date(d.timestamp)),
                y: data.map(d => d.close),
                type: 'scatter',
                mode: 'lines',
                connectgaps: true,
                line: {
                    color: 'rgb(55, 128, 191)',
                    width: 2
                }
            }], {
                title: '',
                xaxis: { 
                    title: '',
                    rangeslider: { visible: false },
                    showgrid: false,
                    showline: true,
                    linecolor: 'black',
                    linewidth: 1,
                    rangebreaks: [
                        { pattern: 'day of week', bounds: [6, 1] },
                        { pattern: 'hour', bounds: [22, 7] }  // UTC-5: 22:00-07:00 (non-trading hours)
                    ]
                },
                yaxis: { 
                    title: '',
                    showgrid: false
                }
            });
        }
        
        Plotly.newPlot('volumeChart', [{
            x: data.map(d => new Date(d.timestamp)),
            y: data.map(d => d.volume),
            type: 'bar'
        }], {
            title: '',
            xaxis: { 
                title: '',
                showgrid: false,
                rangebreaks: [
                    { pattern: 'day of week', bounds: [6, 1] },
                    { pattern: 'hour', bounds: [22, 7] }  // UTC-5: 22:00-07:00 (non-trading hours)
                ]
            },
            yaxis: { 
                title: '',
                showgrid: false
            }
        });
        
    } catch (error) {
        document.getElementById('priceChart').innerHTML = `
            <div class="text-center text-red-600">
                <p>❌ Failed to load price data</p>
                <p class="text-sm text-gray-500">${error.message}</p>
            </div>
        `;
        document.getElementById('volumeChart').innerHTML = `
            <div class="text-center text-red-600">
                <p>❌ Failed to load volume data</p>
                <p class="text-sm text-gray-500">${error.message}</p>
            </div>
        `;
    }
}
</script>
{% endblock %}