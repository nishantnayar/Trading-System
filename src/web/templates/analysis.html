{% extends "base.html" %}
{% from 'components/card_macro.html' import chart_card, stat_card, info_card, large_stat_card %}

{% block title %}Market Analysis{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 30px 40px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .page-header-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .filters-title {
        color: white;
        font-size: 28px;
        font-weight: 700;
        margin: 0;
        text-align: center;
        letter-spacing: 0.5px;
    }

    .filters-wrapper {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 200px;
    }

    .filter-label {
        color: white;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-label i {
        font-size: 12px;
    }

    .page-header .symbol-selector,
    .page-header .filter-selector {
        background: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: #1e293b;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
    }

    .page-header .symbol-selector:focus,
    .page-header .filter-selector:focus {
        outline: none;
        border-color: white;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.2);
    }

    .page-header .symbol-selector:hover,
    .page-header .filter-selector:hover {
        border-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Horizontal Tab Navigation */
    .tab-navigation {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px 16px 0 0;
        display: flex;
        gap: 4px;
        padding: 8px;
        margin-bottom: 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }

    .tab-navigation::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
        opacity: 0.3;
    }

    .tab-button {
        flex: 1;
        padding: 16px 28px;
        background: transparent;
        border: none;
        border-radius: 12px;
        color: #64748b;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tab-button::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        opacity: 0;
        transition: all 0.3s ease;
        border-radius: 12px;
    }

    .tab-button::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        transition: all 0.3s ease;
        transform: translateX(-50%);
        border-radius: 2px;
    }

    .tab-button:hover {
        color: #374151;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    }

    .tab-button:hover::before {
        opacity: 1;
    }

    .tab-button:hover::after {
        width: 60%;
    }

    .tab-button i {
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .tab-button:hover i {
        transform: scale(1.1) rotate(5deg);
    }

    .tab-button.active {
        color: white;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
        transform: translateY(-3px);
    }

    .tab-button.active::before {
        opacity: 0;
    }

    .tab-button.active::after {
        width: 80%;
        background: rgba(255, 255, 255, 0.8);
    }

    .tab-button.active i {
        transform: scale(1.2);
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .tab-content {
        display: none !important;
        opacity: 0;
        transform: translateY(20px);
        background: white;
        border: 1px solid #e2e8f0;
        border-top: none;
        border-radius: 0 0 16px 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .tab-content.active {
        display: block !important;
        animation: slideInUp 0.5s ease-out forwards;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .charts-container {
        width: 100%;
    }

    .charts-header {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .charts-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .controls {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .symbol-selector {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        min-width: 200px;
        transition: all 0.2s;
    }

    .symbol-selector:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .source-selector {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        min-width: 150px;
        transition: all 0.2s;
    }

    .source-selector:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .source-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .source-badge.polygon {
        background: #dbeafe;
        color: #1e40af;
    }

    .source-badge.yahoo {
        background: #fef3c7;
        color: #92400e;
    }

    .source-badge.alpaca {
        background: #d1fae5;
        color: #065f46;
    }

    .timeframe-buttons {
        display: flex;
        gap: 5px;
    }

    .btn {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }

    .btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }

    .btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        display: none;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        text-align: center;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .chart-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .chart-panel {
        background: var(--chart-bg, white);
        border: 1px solid var(--chart-border, #e2e8f0);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .chart-header {
        padding: 15px 20px;
        background: var(--chart-header-bg, #f8fafc);
        border-bottom: 1px solid var(--chart-border, #e2e8f0);
        font-size: 16px;
        font-weight: 600;
        color: var(--chart-text, #1e293b);
        transition: all 0.3s ease;
    }

    /* Dark theme variables */
    .charts-container.dark-theme {
        --chart-bg: #131722;
        --chart-border: #2a2e39;
        --chart-header-bg: #1e222d;
        --chart-text: #d1d4dc;
        --chart-grid: #1e222d;
        --chart-axis: #2a2e39;
    }

    /* Light theme variables (default) */
    .charts-container:not(.dark-theme) {
        --chart-bg: white;
        --chart-border: #e2e8f0;
        --chart-header-bg: #f8fafc;
        --chart-text: #1e293b;
        --chart-grid: #f3f4f6;
        --chart-axis: #e5e7eb;
    }

    .chart-wrapper {
        position: relative;
        width: 100%;
        min-height: 100px;
    }

    .chart-wrapper > div {
        width: 100% !important;
    }

    .chart-panel {
        display: block !important;
        visibility: visible !important;
    }

    .info-bar {
        display: flex;
        gap: 30px;
        padding: 15px 20px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        min-width: 120px;
    }

    .info-label {
        color: #6b7280;
        margin-bottom: 4px;
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 500;
    }

    .info-value {
        color: #1f2937;
        font-weight: 600;
        font-size: 16px;
    }

    .info-value.positive {
        color: #059669;
    }

    .info-value.negative {
        color: #dc2626;
    }

    .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 30px;
        margin: 20px;
        color: #dc2626;
        text-align: center;
    }

    .error-message h3 {
        margin-bottom: 10px;
        font-size: 18px;
    }

    /* Company Info Styles */
    .company-info-container {
        padding: 20px;
    }

    .company-header {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }

    .company-name {
        font-size: 32px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .company-meta {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .company-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        background: #eff6ff;
        color: #1e40af;
    }

    .company-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .company-description-card {
        grid-column: 1 / -1;
    }

    .loading-company {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .loading-company i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #3b82f6;
    }

    /* Institutional Holders Percentage Bar Styles */
    .percentage-bar-container {
        position: relative;
        width: 100%;
        min-width: 120px;
        height: 24px;
        background: transparent;
        border-radius: 12px;
        overflow: visible;
        display: flex;
        align-items: center;
    }

    .percentage-bar-fill {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        border-radius: 12px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: 0;
    }

    .percentage-bar-text {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        font-weight: 600;
        color: #1e293b;
        white-space: nowrap;
        z-index: 2;
    }

    .percentage-cell {
        padding: 12px;
        text-align: center;
        vertical-align: middle;
    }

    @media (max-width: 768px) {
        .page-header {
            padding: 20px;
        }

        .filters-title {
            font-size: 22px;
        }

        .filters-wrapper {
            width: 100%;
        }

        .filter-group {
            min-width: auto;
            flex: 1 1 100%;
        }

        .controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .symbol-selector {
            min-width: auto;
        }
        
        .info-bar {
            gap: 15px;
        }
        
        .info-item {
            min-width: 100px;
        }

        .company-cards-grid {
            grid-template-columns: 1fr;
        }

        .company-name {
            font-size: 24px;
        }

        .company-header {
            padding: 20px;
        }

        .tab-navigation {
            flex-direction: column;
            gap: 6px;
        }

        .tab-button {
            width: 100%;
            padding: 14px 20px;
            font-size: 14px;
        }

        .percentage-bar-container {
            min-width: 100px;
            height: 20px;
        }

        .percentage-bar-text {
            font-size: 11px;
        }
    }

    /* Financial Statements Styles */
    .financial-statements-container {
        padding: 20px;
    }

    .loading-financial-statements {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .loading-financial-statements i {
        font-size: 32px;
        margin-bottom: 16px;
        color: #3b82f6;
    }

    .statement-type-selector {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .statement-type-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        color: #64748b;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .statement-type-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        background: #eff6ff;
    }

    .statement-type-btn.active {
        border-color: #3b82f6;
        background: #3b82f6;
        color: white;
    }

    .statement-type-btn i {
        font-size: 16px;
    }

    .period-type-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
    }

    .period-type-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        color: #6b7280;
        font-weight: 500;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .period-type-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        background: #eff6ff;
    }

    .period-type-btn.active {
        border-color: #3b82f6;
        background: #3b82f6;
        color: white;
    }

    .period-type-btn i {
        font-size: 14px;
    }

    .financial-statements-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .financial-statements-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .financial-statements-table th {
        background: #f8fafc;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
    }

    .financial-statements-table td {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
        color: #4b5563;
    }

    .financial-statements-table tbody tr:hover {
        background: #f8fafc;
    }

    .financial-statements-table tbody tr:last-child td {
        border-bottom: none;
    }

    .financial-value {
        font-weight: 600;
        color: #1f2937;
    }

    .financial-value.positive {
        color: #059669;
    }

    .financial-value.negative {
        color: #dc2626;
    }

    .fiscal-period {
        font-weight: 600;
        color: #1f2937;
    }

    .fiscal-quarter {
        background: #eff6ff;
        color: #1e40af;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .no-data-message {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .no-data-message i {
        font-size: 48px;
        margin-bottom: 16px;
        color: #cbd5e1;
    }

    .no-data-message p {
        font-size: 16px;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .statement-type-selector {
            flex-direction: column;
        }

        .statement-type-btn {
            justify-content: center;
        }

        .period-type-selector {
            justify-content: center;
        }

        .financial-statements-table {
            font-size: 12px;
        }

        .financial-statements-table th,
        .financial-statements-table td {
            padding: 8px 6px;
        }
    }

    /* Company Officers Styles */
    .company-officers-container {
        padding: 20px;
    }

    .officers-by-title {
        display: grid;
        gap: 20px;
        margin-bottom: 30px;
    }

    .officer-title-group {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }

    .officer-title-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f3f4f6;
    }

    .officer-title-header h4 {
        margin: 0;
        color: #374151;
        font-size: 18px;
        font-weight: 600;
    }

    .officer-title-header .officer-count {
        background: #3b82f6;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .officers-list {
        display: grid;
        gap: 15px;
    }

    .officer-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.2s ease;
    }

    .officer-card:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        transform: translateY(-1px);
    }

    .officer-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }

    .officer-name {
        font-weight: 600;
        color: #1f2937;
        font-size: 16px;
        margin: 0;
    }

    .officer-age {
        color: #6b7280;
        font-size: 14px;
        background: #f3f4f6;
        padding: 2px 8px;
        border-radius: 12px;
    }

    .officer-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .officer-detail {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .officer-detail-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .officer-detail-value {
        font-size: 14px;
        color: #374151;
        font-weight: 500;
    }

    .compensation-summary {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        margin-top: 20px;
    }

    .compensation-summary h4 {
        margin: 0 0 15px 0;
        color: #374151;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .compensation-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .compensation-stat {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }

    .compensation-stat-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .compensation-stat-value {
        font-size: 18px;
        color: #1f2937;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .officer-details {
            grid-template-columns: 1fr;
        }
        
        .compensation-stats {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header with Symbol Selector -->
    <div class="page-header">
        <div class="page-header-content">
            <h2 class="filters-title">Select Symbol</h2>
            <div class="flex items-center gap-4 mt-4">
                <a href="/strategies" class="inline-flex items-center px-6 py-3 bg-white/20 backdrop-blur-sm border border-white/30 rounded-full text-white font-semibold hover:bg-white/30 transition-all duration-300">
                    <i class="fas fa-cogs mr-2"></i>
                    Go to Strategies
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            <div class="filters-wrapper">
                <div class="filter-group">
                    <label for="sectorFilter" class="filter-label">
                        <i class="fas fa-briefcase"></i> Sector:
                    </label>
                    <select id="sectorFilter" class="filter-selector">
                        <option value="">All Sectors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="industryFilter" class="filter-label">
                        <i class="fas fa-industry"></i> Industry:
                    </label>
                    <select id="industryFilter" class="filter-selector">
                        <option value="">All Industries</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="symbolSelect" class="filter-label">
                        <i class="fas fa-chart-line"></i> Symbol:
                    </label>
                    <select id="symbolSelect" class="symbol-selector">
                        <option value="">Loading symbols...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

<!-- Horizontal Tab Navigation -->
<div class="tab-navigation">
    <button class="tab-button active" data-tab="company-info">
        <i class="fas fa-building"></i>
        Company Info
    </button>
    <button class="tab-button" data-tab="fundamentals">
        <i class="fas fa-calculator"></i>
        Fundamentals
    </button>
    <button class="tab-button" data-tab="financial-statements">
        <i class="fas fa-file-invoice-dollar"></i>
        Financial Statements
    </button>
    <button class="tab-button" data-tab="company-officers">
        <i class="fas fa-users"></i>
        Company Officers
    </button>
    <button class="tab-button" data-tab="technical-analysis">
        <i class="fas fa-chart-line"></i>
        Technical Analysis
    </button>
</div>

<!-- Company Info Tab -->
<div id="company-info-tab" class="tab-content active">
        <div class="company-info-container">
            <div class="loading-company" id="companyLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading company information...</p>
            </div>
            <div id="companyInfoContent" style="display: none;">
                <!-- Company Header -->
                <div class="company-header">
                    <h1 class="company-name" id="companyName">-</h1>
                    <div class="company-meta">
                        <span class="company-badge" id="companySymbol">-</span>
                        <span class="company-badge" id="companyExchange">-</span>
                        <span class="company-badge" id="companyQuoteType">-</span>
                    </div>
                </div>

                <!-- Company Cards Grid -->
                <div class="company-cards-grid">
                    <!-- Market Cap Card -->
                    {{ large_stat_card(
                        icon='fas fa-chart-line',
                        title='Market Cap',
                        value='-',
                        subtitle='Market Capitalization',
                        color='blue',
                        value_id='companyMarketCap'
                    ) }}

                    <!-- Employees Card -->
                    {{ stat_card(
                        icon='fas fa-users',
                        title='Employees',
                        value='-',
                        description='Total workforce',
                        color='purple',
                        value_id='companyEmployees'
                    ) }}

                    <!-- Sector Card -->
                    {{ stat_card(
                        icon='fas fa-briefcase',
                        title='Sector',
                        value='-',
                        description='Business sector',
                        color='indigo',
                        value_id='companySector'
                    ) }}

                    <!-- Industry Card -->
                    {{ stat_card(
                        icon='fas fa-industry',
                        title='Industry',
                        value='-',
                        description='Industry classification',
                        color='green',
                        value_id='companyIndustry'
                    ) }}

                    <!-- Currency Card -->
                    {{ stat_card(
                        icon='fas fa-dollar-sign',
                        title='Currency',
                        value='-',
                        description='Trading currency',
                        color='yellow',
                        value_id='companyCurrency'
                    ) }}

                    <!-- Exchange Card -->
                    {{ stat_card(
                        icon='fas fa-exchange-alt',
                        title='Exchange',
                        value='-',
                        description='Stock exchange',
                        color='pink',
                        value_id='companyExchangeCard'
                    ) }}

                    <!-- Contact Information Card -->
                    <div class="company-description-card">
                        {{ info_card(
                            title='Contact Information',
                            content='
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div>
                                        <strong style="color: #64748b; display: block; margin-bottom: 5px;">Website</strong>
                                        <span id="companyWebsite">-</span>
                                    </div>
                                    <div>
                                        <strong style="color: #64748b; display: block; margin-bottom: 5px;">Phone</strong>
                                        <span id="companyPhone">-</span>
                                    </div>
                                    <div>
                                        <strong style="color: #64748b; display: block; margin-bottom: 5px;">Address</strong>
                                        <span id="companyAddress">-</span>
                                    </div>
                                    <div>
                                        <strong style="color: #64748b; display: block; margin-bottom: 5px;">City</strong>
                                        <span id="companyCity">-</span>
                                    </div>
                                    <div>
                                        <strong style="color: #64748b; display: block; margin-bottom: 5px;">Country</strong>
                                        <span id="companyCountry">-</span>
                                    </div>
                                </div>
                            ',
                            color='blue'
                        ) }}
                    </div>

                    <!-- Description Card -->
                    <div class="company-description-card">
                        {{ info_card(
                            title='About the Company',
                            content='<p id="companyDescription" style="line-height: 1.8;">-</p>',
                            color='indigo'
                        ) }}
                    </div>

                    <!-- Institutional Holders Card -->
                    <div class="company-description-card">
                        {{ info_card(
                            title='Top Institutional Holders',
                            icon='fas fa-building-columns',
                            content='
                                <div id="institutionalHoldersLoading" style="text-align: center; padding: 20px; color: #64748b;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading institutional holders...
                                </div>
                                <div id="institutionalHoldersContent" style="display: none;">
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 2px solid #e2e8f0;">
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">#</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Institution</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #475569;">Shares</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #475569;">Value</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569;">% Share</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #475569;">Date</th>
                                                </tr>
                                            </thead>
                                            <tbody id="institutionalHoldersTable">
                                                <!-- Data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div id="institutionalHoldersNoData" style="display: none; text-align: center; padding: 30px; color: #64748b;">
                                    <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <p>No institutional holders data available. Load data first.</p>
                                </div>
                            ',
                            color='purple'
                        ) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Company Info Tab -->

    <!-- Fundamentals Tab -->
    <div id="fundamentals-tab" class="tab-content">
        <div class="company-info-container">
            <div class="loading-company" id="fundamentalsLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading key statistics...</p>
            </div>
            <div id="fundamentalsContent" style="display: none;">
                <!-- Fundamentals Header -->
                <div class="company-header">
                    <h1 class="company-name" id="fundCompanyName">-</h1>
                    <div class="company-meta">
                        <span class="company-badge" id="fundSymbol">-</span>
                        <span class="company-badge" id="fundDate">-</span>
                        <span class="company-badge" id="fundSource">-</span>
                    </div>
                </div>

                <!-- Key Statistics Grid -->
                <div class="company-cards-grid">
                    <!-- Market Cap Card (Large) -->
                    {{ large_stat_card(
                        icon='fas fa-chart-line',
                        title='Market Cap',
                        value='-',
                        subtitle='Market Capitalization',
                        color='blue',
                        value_id='fundMarketCapLarge'
                    ) }}

                    <!-- P/E Ratio Card -->
                    {{ stat_card(
                        icon='fas fa-calculator',
                        title='P/E Ratio',
                        value='-',
                        description='Trailing P/E',
                        color='purple',
                        value_id='fundPECard'
                    ) }}

                    <!-- ROE Card -->
                    {{ stat_card(
                        icon='fas fa-percent',
                        title='Return on Equity',
                        value='-',
                        description='Profitability measure',
                        color='green',
                        value_id='fundROECard'
                    ) }}

                    <!-- Profit Margin Card -->
                    {{ stat_card(
                        icon='fas fa-chart-pie',
                        title='Profit Margin',
                        value='-',
                        description='Net profit margin',
                        color='indigo',
                        value_id='fundProfitMarginCard'
                    ) }}

                    <!-- Valuation Metrics -->
                    {{ info_card(
                        title='Valuation Metrics',
                        icon='fas fa-balance-scale',
                        content='
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Market Cap:</strong> <span id="fundMarketCap">-</span></div>
                                <div><strong>Enterprise Value:</strong> <span id="fundEnterpriseValue">-</span></div>
                                <div><strong>P/E (Trailing):</strong> <span id="fundTrailingPE">-</span></div>
                                <div><strong>P/E (Forward):</strong> <span id="fundForwardPE">-</span></div>
                                <div><strong>PEG Ratio:</strong> <span id="fundPEG">-</span></div>
                                <div><strong>Price/Book:</strong> <span id="fundPriceBook">-</span></div>
                                <div><strong>Price/Sales:</strong> <span id="fundPriceSales">-</span></div>
                                <div><strong>EV/Revenue:</strong> <span id="fundEVRevenue">-</span></div>
                                <div><strong>EV/EBITDA:</strong> <span id="fundEVEBITDA">-</span></div>
                            </div>
                        ',
                        color='blue'
                    ) }}

                    <!-- Profitability Metrics -->
                    {{ info_card(
                        title='Profitability Metrics',
                        icon='fas fa-chart-pie',
                        content='
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Profit Margin:</strong> <span id="fundProfitMargin">-</span></div>
                                <div><strong>Operating Margin:</strong> <span id="fundOperatingMargin">-</span></div>
                                <div><strong>Gross Margin:</strong> <span id="fundGrossMargin">-</span></div>
                                <div><strong>EBITDA Margin:</strong> <span id="fundEBITDAMargin">-</span></div>
                                <div><strong>ROE:</strong> <span id="fundROE">-</span></div>
                                <div><strong>ROA:</strong> <span id="fundROA">-</span></div>
                            </div>
                        ',
                        color='green'
                    ) }}

                    <!-- Financial Health -->
                    {{ info_card(
                        title='Financial Health',
                        icon='fas fa-heartbeat',
                        content='
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Total Cash:</strong> <span id="fundTotalCash">-</span></div>
                                <div><strong>Total Debt:</strong> <span id="fundTotalDebt">-</span></div>
                                <div><strong>Debt/Equity:</strong> <span id="fundDebtEquity">-</span></div>
                                <div><strong>Current Ratio:</strong> <span id="fundCurrentRatio">-</span></div>
                                <div><strong>Quick Ratio:</strong> <span id="fundQuickRatio">-</span></div>
                                <div><strong>Free Cash Flow:</strong> <span id="fundFCF">-</span></div>
                                <div><strong>Revenue:</strong> <span id="fundRevenue">-</span></div>
                                <div><strong>EPS:</strong> <span id="fundEPS">-</span></div>
                            </div>
                        ',
                        color='purple'
                    ) }}

                    <!-- Growth Metrics -->
                    {{ stat_card(
                        icon='fas fa-arrow-trend-up',
                        title='Revenue Growth',
                        value='-',
                        description='Year-over-year growth',
                        color='green',
                        value_id='fundRevenueGrowth'
                    ) }}

                    {{ stat_card(
                        icon='fas fa-chart-line',
                        title='Earnings Growth',
                        value='-',
                        description='Year-over-year growth',
                        color='green',
                        value_id='fundEarningsGrowth'
                    ) }}

                    <!-- Trading Metrics -->
                    {{ info_card(
                        title='Trading Metrics',
                        icon='fas fa-chart-line',
                        content='
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Beta:</strong> <span id="fundBeta">-</span></div>
                                <div><strong>52W High:</strong> <span id="fund52WHigh">-</span></div>
                                <div><strong>52W Low:</strong> <span id="fund52WLow">-</span></div>
                                <div><strong>50D Average:</strong> <span id="fund50DAvg">-</span></div>
                                <div><strong>200D Average:</strong> <span id="fund200DAvg">-</span></div>
                                <div><strong>Avg Volume:</strong> <span id="fundAvgVolume">-</span></div>
                            </div>
                        ',
                        color='indigo'
                    ) }}

                    <!-- Dividend & Ownership -->
                    {{ info_card(
                        title='Dividends & Ownership',
                        icon='fas fa-users',
                        content='
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Dividend Yield:</strong> <span id="fundDivYield">-</span></div>
                                <div><strong>Dividend Rate:</strong> <span id="fundDivRate">-</span></div>
                                <div><strong>Payout Ratio:</strong> <span id="fundPayoutRatio">-</span></div>
                                <div><strong>Insider Ownership:</strong> <span id="fundInsiders">-</span></div>
                                <div><strong>Institutional:</strong> <span id="fundInstitutional">-</span></div>
                                <div><strong>Short Interest:</strong> <span id="fundShortInterest">-</span></div>
                            </div>
                        ',
                        color='yellow'
                    ) }}
                </div>
            </div>
        </div>
    </div>
    <!-- End Fundamentals Tab -->

    <!-- Financial Statements Tab -->
    <div id="financial-statements-tab" class="tab-content">
        <div class="financial-statements-container">
            <div class="loading-financial-statements" id="financialStatementsLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading financial statements...</p>
            </div>
            
            <div class="financial-statements-content" id="financialStatementsContent" style="display: none;">
                <!-- Statement Type Selector -->
                <div class="statement-type-selector">
                    <button class="statement-type-btn active" data-type="income">
                        <i class="fas fa-chart-line"></i>
                        Income Statement
                    </button>
                    <button class="statement-type-btn" data-type="balance_sheet">
                        <i class="fas fa-balance-scale"></i>
                        Balance Sheet
                    </button>
                    <button class="statement-type-btn" data-type="cash_flow">
                        <i class="fas fa-coins"></i>
                        Cash Flow
                    </button>
                </div>

                <!-- Period Type Selector -->
                <div class="period-type-selector">
                    <button class="period-type-btn active" data-period="quarterly">
                        <i class="fas fa-calendar-alt"></i>
                        Quarterly
                    </button>
                    <button class="period-type-btn" data-period="annual">
                        <i class="fas fa-calendar"></i>
                        Annual
                    </button>
                </div>

                <!-- Financial Statements Table -->
                <div class="financial-statements-table-container">
                    <div class="table-responsive">
                        <table class="financial-statements-table" id="financialStatementsTable">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Fiscal Year</th>
                                    <th>Q</th>
                                    <th>Revenue</th>
                                    <th>Net Income</th>
                                    <th>EPS</th>
                                    <th>Assets</th>
                                    <th>Liabilities</th>
                                    <th>Equity</th>
                                </tr>
                            </thead>
                            <tbody id="financialStatementsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- No Data Message -->
                <div class="no-data-message" id="financialStatementsNoData" style="display: none;">
                    <i class="fas fa-file-invoice"></i>
                    <p>No financial statements data available</p>
                </div>
            </div>
        </div>
    </div>
    <!-- End Financial Statements Tab -->

    <!-- Company Officers Tab -->
    <div id="company-officers-tab" class="tab-content">
        <div class="company-officers-container">
            <div class="section-header">
                <h3><i class="fas fa-users"></i> Company Officers & Executives</h3>
                <div class="loading-spinner" id="companyOfficersSpinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading company officers...</span>
                </div>
            </div>

            <!-- Officers by Title -->
            <div class="officers-by-title" id="officersByTitle">
                <!-- Content will be populated by JavaScript -->
            </div>

            <!-- Compensation Summary -->
            <div class="compensation-summary" id="compensationSummary" style="display: none;">
                <h4><i class="fas fa-dollar-sign"></i> Compensation Summary</h4>
                <div class="compensation-stats" id="compensationStats">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- No Data Message -->
            <div class="no-data-message" id="companyOfficersNoData" style="display: none;">
                <i class="fas fa-users"></i>
                <p>No company officers data available</p>
            </div>
        </div>
    </div>
    <!-- End Company Officers Tab -->

    <!-- Technical Analysis Tab -->
    <div id="technical-analysis-tab" class="tab-content">
    <div class="charts-container">
        <div class="charts-header">
            <div class="controls">
                <select id="sourceSelect" class="source-selector">
                    <option value="polygon" selected>Polygon.io</option>
                    <option value="yahoo">Yahoo Finance</option>
                </select>
                <div class="timeframe-buttons">
                    <button class="btn" data-days="7">1 Week</button>
                    <button class="btn active" data-days="30">1 Month</button>
                    <button class="btn" data-days="90">3 Months</button>
                    <button class="btn" data-days="180">6 Months</button>
                    <button class="btn" data-days="365">1 Year</button>
                </div>
                <!-- Chart Theme Toggle -->
                <button id="chart-theme-toggle" class="btn" title="Toggle Chart Theme">
                    <i class="fas fa-moon" id="chart-theme-icon"></i>
                    <span id="chart-theme-text">Dark</span>
                </button>
            </div>
        </div>

        <div class="info-bar" id="infoBar" style="display: none;">
            <div class="info-item">
                <span class="info-label">Symbol</span>
                <span class="info-value" id="infoSymbol">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Data Source</span>
                <span class="info-value" id="infoSource">
                    <span class="source-badge" id="sourceBadge">-</span>
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Last Price</span>
                <span class="info-value" id="infoPrice">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Change</span>
                <span class="info-value" id="infoChange">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Volume</span>
                <span class="info-value" id="infoVolume">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">High</span>
                <span class="info-value" id="infoHigh">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Low</span>
                <span class="info-value" id="infoLow">-</span>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading chart data...</div>
        </div>

        <div class="chart-container">
            {{ chart_card(
                title='Price Chart with Moving Averages',
                chart_id='priceChart',
                height='400px'
            ) }}

            {{ chart_card(
                title='Volume',
                chart_id='volumeChart',
                height='120px'
            ) }}

            {{ chart_card(
                title='MACD (12, 26, 9)',
                chart_id='macdChart',
                height='150px'
            ) }}

            {{ chart_card(
                title='RSI (14)',
                chart_id='rsiChart',
                height='150px'
            ) }}
        </div>
    </div>
    </div>
    <!-- End Technical Analysis Tab -->
</div>

<script src="/static/js/indicators.js?v=20"></script>
<script src="/static/js/charts.js?v=20"></script>
<script src="/static/js/company-info.js?v=17"></script>
<script src="/static/js/key-statistics.js?v=2"></script>
<script src="/static/js/institutional-holders.js?v=7"></script>
<script src="/static/js/filters.js?v=14"></script>

<script>
// Financial Statements functionality
let currentStatementType = 'income';
let currentPeriodType = 'quarterly';

function loadFinancialStatements() {
    const symbol = document.getElementById('symbolSelect').value;
    if (!symbol) return;

    const loadingEl = document.getElementById('financialStatementsLoading');
    const contentEl = document.getElementById('financialStatementsContent');
    const noDataEl = document.getElementById('financialStatementsNoData');
    const tableBody = document.getElementById('financialStatementsTableBody');

    // Show loading
    loadingEl.style.display = 'block';
    contentEl.style.display = 'none';
    noDataEl.style.display = 'none';

    // Fetch financial statements data
    const apiUrl = `/api/financial-statements/${symbol}?statement_type=${currentStatementType}&period_type=${currentPeriodType}&limit=20`;
    console.log('Fetching financial statements:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(response => {
            console.log('API response:', response);
            loadingEl.style.display = 'none';
            
            // Check if response has statements array
            const statements = response.statements || response;
            console.log('Statements to display:', statements);
            
            if (statements && statements.length > 0) {
                contentEl.style.display = 'block';
                populateFinancialStatementsTable(statements);
            } else {
                noDataEl.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading financial statements:', error);
            loadingEl.style.display = 'none';
            noDataEl.style.display = 'block';
        });
}

function populateFinancialStatementsTable(statements) {
    console.log('Populating table with statements:', statements);
    const tableBody = document.getElementById('financialStatementsTableBody');
    if (!tableBody) {
        console.error('Table body element not found!');
        return;
    }
    tableBody.innerHTML = '';

    statements.forEach((stmt, index) => {
        console.log(`Processing statement ${index}:`, stmt);
        const row = document.createElement('tr');
        
        // Format period end date
        const periodEnd = new Date(stmt.period_end).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });

        // Format fiscal quarter
        const fiscalQuarter = stmt.fiscal_quarter ? `Q${stmt.fiscal_quarter}` : '-';

        // Format financial values
        const formatValue = (value) => {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'number') {
                if (Math.abs(value) >= 1e9) {
                    return (value / 1e9).toFixed(1) + 'B';
                } else if (Math.abs(value) >= 1e6) {
                    return (value / 1e6).toFixed(1) + 'M';
                } else if (Math.abs(value) >= 1e3) {
                    return (value / 1e3).toFixed(1) + 'K';
                } else {
                    return value.toFixed(2);
                }
            }
            return value;
        };

        // Get values from common metrics or JSONB data
        const revenue = stmt.total_revenue || (stmt.data && stmt.data['Total Revenue']) || null;
        const netIncome = stmt.net_income || (stmt.data && stmt.data['Net Income']) || null;
        const eps = stmt.basic_eps || (stmt.data && stmt.data['Basic EPS']) || null;
        const assets = stmt.total_assets || (stmt.data && stmt.data['Total Assets']) || null;
        const liabilities = stmt.total_liabilities || (stmt.data && stmt.data['Total Liabilities']) || null;
        const equity = stmt.total_equity || (stmt.data && stmt.data['Total Equity']) || null;

        row.innerHTML = `
            <td class="fiscal-period">${periodEnd}</td>
            <td>${stmt.fiscal_year || '-'}</td>
            <td><span class="fiscal-quarter">${fiscalQuarter}</span></td>
            <td class="financial-value">${formatValue(revenue)}</td>
            <td class="financial-value ${netIncome < 0 ? 'negative' : 'positive'}">${formatValue(netIncome)}</td>
            <td class="financial-value">${formatValue(eps)}</td>
            <td class="financial-value">${formatValue(assets)}</td>
            <td class="financial-value">${formatValue(liabilities)}</td>
            <td class="financial-value">${formatValue(equity)}</td>
        `;

        tableBody.appendChild(row);
    });
    console.log(`Table populated with ${statements.length} statements`);
}

// Statement type selector
document.addEventListener('click', function(e) {
    if (e.target.closest('.statement-type-btn')) {
        const btn = e.target.closest('.statement-type-btn');
        const type = btn.getAttribute('data-type');
        console.log('Statement type button clicked:', type);
        
        // Update active button
        document.querySelectorAll('.statement-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update current type and reload data
        currentStatementType = type;
        console.log('Updated currentStatementType to:', currentStatementType);
        loadFinancialStatements();
    }
});

// Period type selector
document.addEventListener('click', function(e) {
    console.log('Click detected on:', e.target);
    if (e.target.closest('.period-type-btn')) {
        const btn = e.target.closest('.period-type-btn');
        const period = btn.getAttribute('data-period');
        console.log('Period type button clicked:', period);
        
        // Update active button
        document.querySelectorAll('.period-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update current period and reload data
        currentPeriodType = period;
        console.log('Updated currentPeriodType to:', currentPeriodType);
        loadFinancialStatements();
    }
});

// Company Officers functionality
function loadCompanyOfficers() {
    const symbol = document.getElementById('symbolSelect').value;
    if (!symbol) return;

    const loadingEl = document.getElementById('companyOfficersSpinner');
    const officersEl = document.getElementById('officersByTitle');
    const compensationEl = document.getElementById('compensationSummary');
    const noDataEl = document.getElementById('companyOfficersNoData');

    // Show loading
    loadingEl.style.display = 'block';
    officersEl.innerHTML = '';
    compensationEl.style.display = 'none';
    noDataEl.style.display = 'none';

    // Fetch company officers data
    const apiUrl = `/api/company-officers/${symbol}`;
    console.log('Fetching company officers:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Company officers data received:', data);
            loadingEl.style.display = 'none';
            
            if (data && data.officers_by_title && Object.keys(data.officers_by_title).length > 0) {
                populateOfficersByTitle(data.officers_by_title);
                if (data.compensation_summary) {
                    populateCompensationSummary(data.compensation_summary);
                    compensationEl.style.display = 'block';
                }
            } else {
                noDataEl.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading company officers:', error);
            loadingEl.style.display = 'none';
            noDataEl.style.display = 'block';
        });
}

function populateOfficersByTitle(officersByTitle) {
    const container = document.getElementById('officersByTitle');
    container.innerHTML = '';

    Object.entries(officersByTitle).forEach(([title, officers]) => {
        const titleGroup = document.createElement('div');
        titleGroup.className = 'officer-title-group';
        
        titleGroup.innerHTML = `
            <div class="officer-title-header">
                <h4>${title}</h4>
                <span class="officer-count">${officers.length}</span>
            </div>
            <div class="officers-list">
                ${officers.map(officer => `
                    <div class="officer-card">
                        <div class="officer-header">
                            <h5 class="officer-name">${officer.name}</h5>
                            ${officer.age ? `<span class="officer-age">Age ${officer.age}</span>` : ''}
                        </div>
                        <div class="officer-details">
                            ${officer.year_born ? `
                                <div class="officer-detail">
                                    <div class="officer-detail-label">Born</div>
                                    <div class="officer-detail-value">${officer.year_born}</div>
                                </div>
                            ` : ''}
                            ${officer.total_pay_display ? `
                                <div class="officer-detail">
                                    <div class="officer-detail-label">Total Pay</div>
                                    <div class="officer-detail-value">${officer.total_pay_display}</div>
                                </div>
                            ` : ''}
                            ${officer.exercised_value_display ? `
                                <div class="officer-detail">
                                    <div class="officer-detail-label">Exercised Value</div>
                                    <div class="officer-detail-value">${officer.exercised_value_display}</div>
                                </div>
                            ` : ''}
                            ${officer.unexercised_value_display ? `
                                <div class="officer-detail">
                                    <div class="officer-detail-label">Unexercised Value</div>
                                    <div class="officer-detail-value">${officer.unexercised_value_display}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.appendChild(titleGroup);
    });
}

function populateCompensationSummary(summary) {
    const container = document.getElementById('compensationStats');
    container.innerHTML = '';

    const stats = [
        { label: 'Total Officers', value: summary.total_officers },
        { label: 'Average Total Pay', value: summary.average_total_pay },
        { label: 'Median Total Pay', value: summary.median_total_pay },
        { label: 'Highest Paid', value: summary.highest_paid },
        { label: 'Total Exercised Value', value: summary.total_exercised_value },
        { label: 'Total Unexercised Value', value: summary.total_unexercised_value }
    ];

    stats.forEach(stat => {
        if (stat.value) {
            const statEl = document.createElement('div');
            statEl.className = 'compensation-stat';
            statEl.innerHTML = `
                <div class="compensation-stat-label">${stat.label}</div>
                <div class="compensation-stat-value">${stat.value}</div>
            `;
            container.appendChild(statEl);
        }
    });
}

// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // If switching to technical analysis tab, resize charts
            if (tabName === 'technical-analysis' && window.dashboard) {
                setTimeout(() => {
                    window.dashboard.resizeCharts();
                }, 50);
            }
            
            // If switching to financial statements tab, load data
            if (tabName === 'financial-statements') {
                loadFinancialStatements();
            }
            
            // If switching to company officers tab, load data
            if (tabName === 'company-officers') {
                loadCompanyOfficers();
            }
        });
    });
    
    // Ensure default tab is active on load
    const defaultTab = document.querySelector('.tab-button.active');
    if (defaultTab) {
        const defaultTabName = defaultTab.getAttribute('data-tab');
        document.getElementById(`${defaultTabName}-tab`).classList.add('active');
    }
});

// Chart theme management
let currentChartTheme = 'light';

// Initialize chart theme on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeChartTheme();
});

function initializeChartTheme() {
    const themeToggle = document.getElementById('chart-theme-toggle');
    const themeIcon = document.getElementById('chart-theme-icon');
    const themeText = document.getElementById('chart-theme-text');
    const chartsContainer = document.querySelector('.charts-container');

    // Check for saved theme preference or default to light mode
    const savedTheme = localStorage.getItem('chart-theme') || 'light';
    currentChartTheme = savedTheme;

    // Apply the saved theme
    if (savedTheme === 'dark') {
        chartsContainer.classList.add('dark-theme');
        themeIcon.className = 'fas fa-sun';
        themeText.textContent = 'Light';
    } else {
        chartsContainer.classList.remove('dark-theme');
        themeIcon.className = 'fas fa-moon';
        themeText.textContent = 'Dark';
    }

    // Theme toggle event listener
    themeToggle.addEventListener('click', function() {
        const isDark = chartsContainer.classList.contains('dark-theme');
        
        if (isDark) {
            // Switch to light mode
            chartsContainer.classList.remove('dark-theme');
            themeIcon.className = 'fas fa-moon';
            themeText.textContent = 'Dark';
            currentChartTheme = 'light';
            localStorage.setItem('chart-theme', 'light');
        } else {
            // Switch to dark mode
            chartsContainer.classList.add('dark-theme');
            themeIcon.className = 'fas fa-sun';
            themeText.textContent = 'Light';
            currentChartTheme = 'dark';
            localStorage.setItem('chart-theme', 'dark');
        }

        // Update charts if they exist
        if (window.dashboard && window.dashboard.charts) {
            window.dashboard.updateChartTheme(currentChartTheme);
        }
    });
}

// Function to get current chart theme colors
function getChartThemeColors(theme) {
    if (theme === 'dark') {
        return {
            background: '#131722',
            textColor: '#d1d4dc',
            grid: {
                vertLines: { color: '#1e222d' },
                horzLines: { color: '#1e222d' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
                horzLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
            },
            timeScale: {
                borderColor: '#2a2e39',
                timeVisible: true,
                secondsVisible: false,
            },
            rightPriceScale: {
                borderColor: '#2a2e39',
            },
        };
    } else {
        return {
            background: '#ffffff',
            textColor: '#191919',
            grid: {
                vertLines: { color: '#f0f0f0' },
                horzLines: { color: '#f0f0f0' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
                horzLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
            },
            timeScale: {
                borderColor: '#e0e0e0',
                timeVisible: true,
                secondsVisible: false,
            },
            rightPriceScale: {
                borderColor: '#e0e0e0',
            },
        };
    }

}
</script>
{% endblock %}