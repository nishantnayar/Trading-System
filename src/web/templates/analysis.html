{% extends "base.html" %}
{% from 'components/card_macro.html' import stat_card %}

{% block title %}Market Analysis{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    .charts-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .charts-header {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .charts-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .controls {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .symbol-selector {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        min-width: 200px;
        transition: all 0.2s;
    }

    .symbol-selector:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .timeframe-buttons {
        display: flex;
        gap: 5px;
    }

    .btn {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }

    .btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }

    .btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        display: none;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        text-align: center;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .chart-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .chart-panel {
        background: var(--chart-bg, white);
        border: 1px solid var(--chart-border, #e2e8f0);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .chart-header {
        padding: 15px 20px;
        background: var(--chart-header-bg, #f8fafc);
        border-bottom: 1px solid var(--chart-border, #e2e8f0);
        font-size: 16px;
        font-weight: 600;
        color: var(--chart-text, #1e293b);
        transition: all 0.3s ease;
    }

    /* Dark theme variables */
    .charts-container.dark-theme {
        --chart-bg: #131722;
        --chart-border: #2a2e39;
        --chart-header-bg: #1e222d;
        --chart-text: #d1d4dc;
        --chart-grid: #1e222d;
        --chart-axis: #2a2e39;
    }

    /* Light theme variables (default) */
    .charts-container:not(.dark-theme) {
        --chart-bg: white;
        --chart-border: #e2e8f0;
        --chart-header-bg: #f8fafc;
        --chart-text: #1e293b;
        --chart-grid: #f3f4f6;
        --chart-axis: #e5e7eb;
    }

    .chart-wrapper {
        position: relative;
    }

    #priceChart {
        height: 400px;
    }

    #volumeChart {
        height: 120px;
    }

    #macdChart {
        height: 150px;
    }

    #rsiChart {
        height: 150px;
    }

    .info-bar {
        display: flex;
        gap: 30px;
        padding: 15px 20px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        min-width: 120px;
    }

    .info-label {
        color: #6b7280;
        margin-bottom: 4px;
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 500;
    }

    .info-value {
        color: #1f2937;
        font-weight: 600;
        font-size: 16px;
    }

    .info-value.positive {
        color: #059669;
    }

    .info-value.negative {
        color: #dc2626;
    }

    .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 30px;
        margin: 20px;
        color: #dc2626;
        text-align: center;
    }

    .error-message h3 {
        margin-bottom: 10px;
        font-size: 18px;
    }

    @media (max-width: 768px) {
        .controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .symbol-selector {
            min-width: auto;
        }
        
        .info-bar {
            gap: 15px;
        }
        
        .info-item {
            min-width: 100px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h1 class="text-2xl font-bold text-gray-900">Market Analysis</h1>
        <p class="text-gray-600 mt-2">Professional multi-pane trading charts with technical indicators</p>
    </div>

    <!-- Market Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Total Symbols Card -->
        {{ stat_card(
            icon='fas fa-chart-bar',
            title='Total Symbols',
            value='-',
            description='Available trading symbols',
            color='blue',
            value_id='totalSymbols'
        ) }}

        <!-- Total Records Card -->
        {{ stat_card(
            icon='fas fa-database',
            title='Total Records',
            value='-',
            description='Market data records',
            color='green',
            value_id='totalRecords'
        ) }}

        <!-- Last Update Card -->
        {{ stat_card(
            icon='fas fa-clock',
            title='Last Update',
            value='-',
            description='Most recent data refresh',
            color='purple',
            value_id='lastUpdate'
        ) }}
    </div>

    <!-- Professional Trading Charts -->
    <div class="charts-container">
        <div class="charts-header">
            <h1 class="charts-title">
                <i class="fas fa-chart-candlestick"></i>
                Professional Trading Charts
            </h1>
            <div class="controls">
                <select id="symbolSelect" class="symbol-selector">
                    <option value="">Loading symbols...</option>
                </select>
                <div class="timeframe-buttons">
                    <button class="btn" data-days="7">1 Week</button>
                    <button class="btn" data-days="30">1 Month</button>
                    <button class="btn active" data-days="90">3 Months</button>
                    <button class="btn" data-days="180">6 Months</button>
                    <button class="btn" data-days="365">1 Year</button>
                </div>
                <!-- Chart Theme Toggle -->
                <button id="chart-theme-toggle" class="btn" title="Toggle Chart Theme">
                    <i class="fas fa-moon" id="chart-theme-icon"></i>
                    <span id="chart-theme-text">Dark</span>
                </button>
            </div>
        </div>

        <div class="info-bar" id="infoBar" style="display: none;">
            <div class="info-item">
                <span class="info-label">Symbol</span>
                <span class="info-value" id="infoSymbol">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Last Price</span>
                <span class="info-value" id="infoPrice">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Change</span>
                <span class="info-value" id="infoChange">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Volume</span>
                <span class="info-value" id="infoVolume">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">High</span>
                <span class="info-value" id="infoHigh">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Low</span>
                <span class="info-value" id="infoLow">-</span>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading chart data...</div>
        </div>

        <div class="chart-container">
            <div class="chart-panel">
                <div class="chart-header">Price Chart with Moving Averages</div>
                <div class="chart-wrapper">
                    <div id="priceChart"></div>
                </div>
            </div>

            <div class="chart-panel">
                <div class="chart-header">Volume</div>
                <div class="chart-wrapper">
                    <div id="volumeChart"></div>
                </div>
            </div>

            <div class="chart-panel">
                <div class="chart-header">MACD (12, 26, 9)</div>
                <div class="chart-wrapper">
                    <div id="macdChart"></div>
                </div>
            </div>

            <div class="chart-panel">
                <div class="chart-header">RSI (14)</div>
                <div class="chart-wrapper">
                    <div id="rsiChart"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/indicators.js"></script>
<script src="/static/js/charts.js"></script>

<script>
// Chart theme management
let currentChartTheme = 'light';

// Load market statistics for the cards
document.addEventListener('DOMContentLoaded', function() {
    loadMarketStats();
    initializeChartTheme();
});

function initializeChartTheme() {
    const themeToggle = document.getElementById('chart-theme-toggle');
    const themeIcon = document.getElementById('chart-theme-icon');
    const themeText = document.getElementById('chart-theme-text');
    const chartsContainer = document.querySelector('.charts-container');

    // Check for saved theme preference or default to light mode
    const savedTheme = localStorage.getItem('chart-theme') || 'light';
    currentChartTheme = savedTheme;

    // Apply the saved theme
    if (savedTheme === 'dark') {
        chartsContainer.classList.add('dark-theme');
        themeIcon.className = 'fas fa-sun';
        themeText.textContent = 'Light';
    } else {
        chartsContainer.classList.remove('dark-theme');
        themeIcon.className = 'fas fa-moon';
        themeText.textContent = 'Dark';
    }

    // Theme toggle event listener
    themeToggle.addEventListener('click', function() {
        const isDark = chartsContainer.classList.contains('dark-theme');
        
        if (isDark) {
            // Switch to light mode
            chartsContainer.classList.remove('dark-theme');
            themeIcon.className = 'fas fa-moon';
            themeText.textContent = 'Dark';
            currentChartTheme = 'light';
            localStorage.setItem('chart-theme', 'light');
        } else {
            // Switch to dark mode
            chartsContainer.classList.add('dark-theme');
            themeIcon.className = 'fas fa-sun';
            themeText.textContent = 'Light';
            currentChartTheme = 'dark';
            localStorage.setItem('chart-theme', 'dark');
        }

        // Update charts if they exist
        if (window.dashboard && window.dashboard.charts) {
            window.dashboard.updateChartTheme(currentChartTheme);
        }
    });
}

// Function to get current chart theme colors
function getChartThemeColors(theme) {
    if (theme === 'dark') {
        return {
            background: '#131722',
            textColor: '#d1d4dc',
            grid: {
                vertLines: { color: '#1e222d' },
                horzLines: { color: '#1e222d' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
                horzLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
            },
            timeScale: {
                borderColor: '#2a2e39',
                timeVisible: true,
                secondsVisible: false,
            },
            rightPriceScale: {
                borderColor: '#2a2e39',
            },
        };
    } else {
        return {
            background: '#ffffff',
            textColor: '#191919',
            grid: {
                vertLines: { color: '#f0f0f0' },
                horzLines: { color: '#f0f0f0' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
                horzLine: {
                    color: '#758696',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                },
            },
            timeScale: {
                borderColor: '#e0e0e0',
                timeVisible: true,
                secondsVisible: false,
            },
            rightPriceScale: {
                borderColor: '#e0e0e0',
            },
        };
    }
}

async function loadMarketStats() {
    try {
        const response = await fetch('/api/market-data/stats');
        const stats = await response.json();
        
        console.log('Market stats:', stats); // Debug log
        
        document.getElementById('totalSymbols').textContent = stats.symbols_count || '-';
        document.getElementById('totalRecords').textContent = stats.total_records ? stats.total_records.toLocaleString() : '-';
        
        // Format last update to be user-friendly
        if (stats.latest_update) {
            const date = new Date(stats.latest_update);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: 'America/Chicago' // Convert from UTC to Central Time
            };
            document.getElementById('lastUpdate').textContent = date.toLocaleDateString('en-US', options);
        } else {
            document.getElementById('lastUpdate').textContent = '-';
        }
    } catch (error) {
        console.error('Failed to load market stats:', error);
        document.getElementById('totalSymbols').textContent = 'Error';
        document.getElementById('totalRecords').textContent = 'Error';
        document.getElementById('lastUpdate').textContent = 'Error';
    }
}
</script>
{% endblock %}